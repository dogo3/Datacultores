---
title: "AED"
author: "Jose Francisco Domenech Gomis, Eva Barrero Sánchez y Francesc Ruiz Rius"
date: "19/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(lubridate)
library(forcats)
library(zoo)
```


```{r}
dfMAPAConsumo <- read_delim("data/Dataset1.- DatosConsumoAlimentarioMAPAporCCAA.txt", "|", escape_double = FALSE, 
           col_types = cols(X11 = col_skip(), X12 = col_skip()), locale = locale(decimal_mark = ","), trim_ws = TRUE)
head(dfMAPAConsumo)
```

Filtro para tener los totales nacionales.
```{r}
dfMAPAConsumo_Total <- dfMAPAConsumo[grep('Total', dfMAPAConsumo$CCAA),]
head(dfMAPAConsumo_Total)
```

Convierto los productos en factor, para analizar por ellos.
Paso también los meses a factor.
Creo una columna nueva que sume ambos.
La convierto a fecha.
```{r}
niveles <- c('Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto',
             'Septiembre', 'Octubre', 'Noviembre', 'Diciembre')
dfMAPAConsumo_Total$Mes <- factor(dfMAPAConsumo_Total$Mes, levels=niveles, labels=c(1:12))
dfMAPAConsumo_Total$Producto <- as.factor(dfMAPAConsumo_Total$Producto)
dfMAPAConsumo_Total <- unite(dfMAPAConsumo_Total, Mes, Año, col='Fecha', sep='/',remove=F)
dfMAPAConsumo_Total$Fecha <- as.Date(as.yearmon(dfMAPAConsumo_Total$Fecha, format='%m/%Y'))
str(dfMAPAConsumo_Total)
```

Tenemos 51 tipos de productos. Ahora podemos ver la evolución.

```{r}
ggplot(dfMAPAConsumo_Total)+
  geom_line(aes(x=Fecha, y=`Precio medio kg`, col=Producto))+
  scale_x_date(date_breaks = 'months',date_labels = "%b %Y")+
  theme(legend.position = "none",axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
```
Muchas cosas y muy feo

To Do: 
- se pueden analizar los precios de los 3-5 productos con mas volumen, por ejemplo.
- analizar consumo de ellos
- ver si el gasto se ha visto influenciado

```{r}
dfPreciosAndalucia <- read_delim("data/Dataset2.- Precios Semanales Observatorio de Precios Junta de Andalucia.txt", "|", escape_double = FALSE, trim_ws = TRUE)

dfPreciosAndalucia<-mutate(dfPreciosAndalucia,INICIO=dmy(INICIO),FIN=dmy(FIN))
dfPreciosAndalucia<-mutate(dfPreciosAndalucia,PRECIO=as.numeric(gsub("," ,".", PRECIO)))

# dfPreciosAndalucia<-mutate(dfPreciosAndalucia,YEAR_WEEK=paste(as.character(year(ymd(INICIO))),as.character(week(ymd(INICIO)))))
dfPreciosAndalucia<-mutate(dfPreciosAndalucia,YEAR_MONTH=factor(paste(year(INICIO),month(INICIO,label=T))))
#dfPreciosAndalucia<-mutate(dfPreciosAndalucia,INICIO=as.factor(INICIO))
head(dfPreciosAndalucia)
# View(dfPreciosAndalucia)
unique(dfPreciosAndalucia$GRUPO)
unique(dfPreciosAndalucia$SECTOR)
print(unique(dfPreciosAndalucia$SUBSECTOR))
```

Notas:
  - Grupo: Agricola/Agricultura ecológica

```{r}
citricos<-filter(dfPreciosAndalucia,SUBSECTOR=="Citricos")
ggplotly(ggplot(data=citricos,aes(x=INICIO,y=PRECIO,color=PRODUCTO))+
           geom_line(size=0.3)+ 
           scale_x_date(date_breaks = "months",date_labels = "%b %Y")+
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
)

# pimientos<-filter(dfPreciosAndalucia,PRODUCTO=="AGUACATE")
# ggplotly(ggplot(data=pimientos,aes(x=INICIO,y=PRECIO,color=SUBTIPO,shape=TIPO))+
#            geom_line(size=0.8)+
#            scale_x_date(date_breaks = "months",date_labels = "%b %Y")+
#            theme(legend.position = "none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
# )

```

```{r}
ggplot(dfPreciosAndalucia,aes(x=INICIO,y=PRECIO))+
  geom_boxplot(aes(group=YEAR_MONTH),outlier.size = 0.5)+
  theme(legend.position = "none",axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_x_date(date_breaks = "months",date_labels = "%b %Y")+
  scale_y_sqrt()
```



```{r}
dfMercaMadrid <- read_delim("data/Dataset3a_Datos_MercaMadrid.txt", "|", escape_double = FALSE, trim_ws = TRUE,
                            locale = locale(decimal_mark = ","))
head(dfMercaMadrid)
```

```{r}
dfMercaBarna <- read_delim("data/Dataset3b_Datos_MercaBarna.txt", "|", escape_double = FALSE, trim_ws = TRUE,
                           locale = locale(decimal_mark = ","))
head(dfMercaBarna)
```

```{r}
dfComercioExterior <- read_delim("data/Dataset4.- Comercio Exterior de Espana.txt", "|", escape_double = FALSE, col_types = cols(Value = col_character()), 
    trim_ws = TRUE, na=":")
dfComercioExterior<-pivot_wider(data=dfComercioExterior,names_from=c("INDICATORS","FLOW"),values_from=c("Value"),values_fn = list)

dfComercioExterior$QUANTITY_IN_100KG_IMPORT <- as.numeric(dfComercioExterior$QUANTITY_IN_100KG_IMPORT)
dfComercioExterior$QUANTITY_IN_100KG_EXPORT <- as.numeric(dfComercioExterior$QUANTITY_IN_100KG_EXPORT)
dfComercioExterior$VALUE_IN_EUROS_IMPORT <- as.numeric(dfComercioExterior$VALUE_IN_EUROS_IMPORT)
dfComercioExterior$VALUE_IN_EUROS_EXPORT <- as.numeric(dfComercioExterior$VALUE_IN_EUROS_EXPORT)

dfComercioExterior<-mutate(dfComercioExterior,YEAR_MONTH=paste(as.character(year(my(PERIOD))),as.character(month(my(PERIOD),label=T))))

head(dfComercioExterior)
View(dfComercioExterior)
```
El dataset 4 daba problemas porque las filas cuyo producto era "Fresh or dried citrus fruit (excl. oranges, lemons..." estaban mal codificadas y tenian una columna de más, esto se ha corregido previamente con un editor de texto.

*Importante:* La columna REPORTER es la que nos indica el sujeto de la transacción, la columna PARTNER es siempre España mientras que REPORTER indica con quién ha operado España, por tanto cuando hablamos de importaciones del REPORTER realmente hablamos de exportaciones de España y viceversa.

```{r}
totalImpKg<-sum(unlist(dfComercioExterior$QUANTITY_IN_100KG_IMPORT),na.rm = T)
totalExpKg<-sum(unlist(dfComercioExterior$QUANTITY_IN_100KG_EXPORT),na.rm = T)
totalImpEur<-sum(unlist(dfComercioExterior$VALUE_IN_EUROS_IMPORT),na.rm = T)
totalExpEur<-sum(unlist(dfComercioExterior$VALUE_IN_EUROS_EXPORT),na.rm = T)

print(paste("Total importaciones a toneladas:      ",totalExpKg/10))
print(paste("Total exportaciones desde toneladas:  ",totalImpKg/10))
print(paste("Total importaciones a España en €:    ",totalExpEur))
print(paste("Total exportaciones desde España en €:",totalImpEur))
```

```{r}
#TODO corregir esti para que el eje X aparezca bien ordenado
dfComercioExteriorFilt<-filter(dfComercioExterior,REPORTER=="Poland")
ggplotly(ggplot(data=dfComercioExteriorFilt,aes(x=YEAR_MONTH,y=VALUE_IN_EUROS_EXPORT,color=PRODUCT))+geom_point()+theme(legend.position = "none",axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)))
```



```{r}
dfCovid <- read_delim("data/Dataset5_Coronavirus_cases.txt", "|", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::select(-day, -year) %>% 
  mutate(`Cumulative_number_for_14_days_of_COVID-19_cases_per_100000`=
           as.numeric(gsub("," ,".", `Cumulative_number_for_14_days_of_COVID-19_cases_per_100000`)))
dfCovid$dateRep <- dmy(dfCovid$dateRep)

head(dfCovid)
```

```{r}
#Filtrar los datos españoles.
dfCovid_Espana <- dfCovid %>% filter(countriesAndTerritories %in% 'Spain') %>% arrange(dateRep)
#ponerle a la columna casos y muertes, NA donde hay 0.
dfCovid_Espana$cases[dfCovid_Espana$cases == '0'] <- NA
dfCovid_Espana$deaths[dfCovid_Espana$deaths == '0'] <- NA
head(dfCovid_Espana)

#casos
# ggplot() + 
#   geom_line(data=subset(dfCovid_Espana, !is.na(cases)), aes(x=dateRep, y=cases))+
#   geom_smooth(data=subset(dfCovid_Espana, !is.na(cases)), aes(x=dateRep, y=cases))
#muertes
# ggplot() +
#   geom_line(data=subset(dfCovid_Espana, !is.na(deaths)), aes(x=dateRep, y=deaths))+
#   geom_smooth(data=subset(dfCovid_Espana, !is.na(deaths)), aes(x=dateRep, y=deaths))
# 
#incidencia acumulada
ggplot(dfCovid_Espana) +
  geom_line(aes(x=dateRep, y=`Cumulative_number_for_14_days_of_COVID-19_cases_per_100000`), col='dark blue')+
  labs(x='Fecha', y='IA 14', title='Evolución IA14 España')+
  scale_x_date(date_breaks = "month",date_labels = "%b %Y")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Gráfico casos: existen datos registrados cada dos o tres días, que se corresponden con el acumulado de esos días. Por tanto, no tiene mucho sentido trabajar con esos datos.

Gráfico muertes: ídem que casos, incluso datos negativos!!

Habría que usar alguna aproximación de ellos?


Mapa de España, para utilizarlo más adelante.

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(rgdal)
library(raster)
library(broom)
```


```{r}
shapefile_provincias <- readOGR("assets/Provincias_ETRS89_30N.shp")
```

```{r}
data_provincias <- tidy(shapefile_provincias)
nombres_provincias <- tibble(shapefile_provincias$Texto) %>% 
  mutate(id = as.character(seq(0, nrow(.)-1)))

data_provincias_mapa <- data_provincias %>% 
  left_join(nombres_provincias, by = "id")
```

```{r}
data_provincias_mapa %>%
  ggplot() +
  geom_polygon(aes( x= long, y = lat, group = group),
               fill = "steelblue", alpha = 0.8, size = 0.05, col = 'tomato2') +
  theme_void() + 
  ggtitle("Mapa de España separado por provincias")
```