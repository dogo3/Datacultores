---
title: "AED"
author: "Jose Francisco Domenech Gomis, Eva Barrero Sánchez y Francesc Ruiz Rius"
date: "19/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(lubridate)
```


```{r}
dfMAPAConsumo <- read_delim("data/Dataset1.- DatosConsumoAlimentarioMAPAporCCAA.txt", "|", escape_double = FALSE, trim_ws = TRUE)
head(dfMAPAConsumo)
```


```{r}
dfPreciosAndalucia <- read_delim("data/Dataset2.- Precios Semanales Observatorio de Precios Junta de Andalucia.txt", "|", escape_double = FALSE, trim_ws = TRUE)

dfPreciosAndalucia<-mutate(dfPreciosAndalucia,INICIO=dmy(INICIO),FIN=dmy(FIN))
dfPreciosAndalucia<-mutate(dfPreciosAndalucia,PRECIO=as.numeric(gsub("," ,".", PRECIO)))
dfPreciosAndalucia<-mutate(dfPreciosAndalucia,YEAR_WEEK=paste(as.character(year(ymd(INICIO))),as.character(week(ymd(INICIO)))))
#dfPreciosAndalucia<-mutate(dfPreciosAndalucia,INICIO=as.factor(INICIO))
head(dfPreciosAndalucia)
View(dfPreciosAndalucia)
```

Notas:
  - Grupo: Agricola/Agricultura ecológica

```{r}
citricos<-filter(dfPreciosAndalucia,SUBSECTOR=="Citricos")
ggplotly(ggplot(data=citricos,aes(x=INICIO,y=PRECIO,color=PRODUCTO))+
           geom_line(size=0.3)+ 
           scale_x_date(date_breaks = "months",date_labels = "%b %Y")+
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
)

# pimientos<-filter(dfPreciosAndalucia,PRODUCTO=="AGUACATE")
# ggplotly(ggplot(data=pimientos,aes(x=INICIO,y=PRECIO,color=SUBTIPO,shape=TIPO))+
#            geom_line(size=0.8)+
#            scale_x_date(date_breaks = "months",date_labels = "%b %Y")+
#            theme(legend.position = "none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
# )

```


```{r}
dfMercaMadrid <- read_delim("data/Dataset3a_Datos_MercaMadrid.txt", "|", escape_double = FALSE, trim_ws = TRUE)
head(dfMercaMadrid)
```

```{r}
dfMercaBarna <- read_delim("data/Dataset3b_Datos_MercaBarna.txt", "|", escape_double = FALSE, trim_ws = TRUE)
head(dfMercaBarna)
```

```{r}
dfComercioExterior <- read_delim("data/Dataset4.- Comercio Exterior de Espana.txt", "|", escape_double = FALSE, col_types = cols(Value = col_character()), 
    trim_ws = TRUE, na=":")
dfComercioExterior<-pivot_wider(data=dfComercioExterior,names_from=c("INDICATORS","FLOW"),values_from=c("Value"),values_fn = list)

dfComercioExterior$QUANTITY_IN_100KG_IMPORT <- as.numeric(dfComercioExterior$QUANTITY_IN_100KG_IMPORT)
dfComercioExterior$QUANTITY_IN_100KG_EXPORT <- as.numeric(dfComercioExterior$QUANTITY_IN_100KG_EXPORT)
dfComercioExterior$VALUE_IN_EUROS_IMPORT <- as.numeric(dfComercioExterior$VALUE_IN_EUROS_IMPORT)
dfComercioExterior$VALUE_IN_EUROS_EXPORT <- as.numeric(dfComercioExterior$VALUE_IN_EUROS_EXPORT)

dfComercioExterior<-mutate(dfComercioExterior,YEAR_MONTH=paste(as.character(year(my(PERIOD))),as.character(month(my(PERIOD)))))

head(dfComercioExterior)
View(dfComercioExterior)
```
El dataset 4 daba problemas porque las filas cuyo producto era "Fresh or dried citrus fruit (excl. oranges, lemons..." estaban mal codificadas y tenian una columna de más, esto se ha corregido previamente con un editor de texto.

```{r}
totalImpKg<-sum(unlist(dfComercioExterior$QUANTITY_IN_100KG_IMPORT),na.rm = T)
totalExpKg<-sum(unlist(dfComercioExterior$QUANTITY_IN_100KG_EXPORT),na.rm = T)
totalImpEur<-sum(unlist(dfComercioExterior$VALUE_IN_EUROS_IMPORT),na.rm = T)
totalExpEur<-sum(unlist(dfComercioExterior$VALUE_IN_EUROS_EXPORT),na.rm = T)
print(paste("Total importaciones en toneladas:",totalImpKg/10))
print(paste("Total exportaciones en toneladas:",totalExpKg/10))
print(paste("Total importaciones en €:",totalImpEur))
print(paste("Total exportaciones en €:",totalExpEur))
```

```{r}
dfComercioExteriorFilt<-filter(dfComercioExterior,REPORTER=="Poland")
ggplotly(ggplot(data=dfComercioExteriorFilt,aes(x=YEAR_MONTH,y=VALUE_IN_EUROS_EXPORT,color=PRODUCT))+geom_point()+theme(legend.position = "none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))
```



```{r}
dfCovid <- read_delim("data/Dataset5_Coronavirus_cases.txt", "|", escape_double = FALSE, trim_ws = TRUE) %>% dplyr::select(-day, -month, -year)
dfCovid$dateRep <- dmy(dfCovid$dateRep)
head(dfCovid)
```

```{r}
#Filtrar los datos españoles.
dfCovid_Espana <- dfCovid %>% filter(countriesAndTerritories %in% 'Spain') %>% arrange(dateRep)
#ponerle a la columna casos y muertes, NA donde hay 0.
dfCovid_Espana$cases[dfCovid_Espana$cases == '0'] <- NA
dfCovid_Espana$deaths[dfCovid_Espana$deaths == '0'] <- NA
head(dfCovid_Espana)

ggplot() + 
  geom_line(data=subset(dfCovid_Espana, !is.na(cases)), aes(x=dateRep, y=cases))+
  geom_smooth(data=subset(dfCovid_Espana, !is.na(cases)), aes(x=dateRep, y=cases))
ggplot() +
  geom_line(data=subset(dfCovid_Espana, !is.na(deaths)), aes(x=dateRep, y=deaths))+
  geom_smooth(data=subset(dfCovid_Espana, !is.na(deaths)), aes(x=dateRep, y=deaths))
```

Gráfico casos: existen datos registrados cada dos o tres días, que se corresponden con el acumulado de esos días. Por tanto, no tiene mucho sentido trabajar con esos datos.

Gráfico muertes: ídem que casos, incluso datos negativos!!

Habría que usar alguna aproximación de ellos?


Mapa de España, para utilizarlo más adelante.

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(rgdal)
library(raster)
library(broom)
```


```{r}
shapefile_provincias <- readOGR("assets/Provincias_ETRS89_30N.shp")
```

```{r}
data_provincias <- tidy(shapefile_provincias)
nombres_provincias <- tibble(shapefile_provincias$Texto) %>% 
  mutate(id = as.character(seq(0, nrow(.)-1)))

data_provincias_mapa <- data_provincias %>% 
  left_join(nombres_provincias, by = "id")
```

```{r}
data_provincias_mapa %>%
  ggplot() +
  geom_polygon(aes( x= long, y = lat, group = group),
               fill = "steelblue", alpha = 0.8, size = 0.05, col = 'tomato2') +
  theme_void() + 
  ggtitle("Mapa de España separado por provincias")
```